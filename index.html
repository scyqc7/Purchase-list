<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‡è´­æ¸…å•åä½œç³»ç»Ÿï¼ˆFirebaseå®æ—¶åŒæ­¥ï¼‰</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; margin: 0; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 0 10px #ddd; padding: 30px; }
        h2, h4 { color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #007bff; color: #fff; }
        .btn { padding: 6px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-warning { background: #ffc107; color: #000; }
        .archived-modal { position: fixed; top: 5%; left: 10%; width: 80%; height: 80%; background: #fff; border: 2px solid #007bff; border-radius: 8px; z-index: 9999; overflow: auto; box-shadow: 0 0 20px #007bff55; display: none; }
        .archived-modal-content { padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>é‡‡è´­æ¸…å•åä½œç³»ç»Ÿï¼ˆFirebaseå®æ—¶åŒæ­¥ï¼‰</h2>
        <div>
            <label>ç”¨æˆ·å | Username: <input id="username" type="text" style="margin-right:10px;"></label>
            <button class="btn btn-primary" onclick="login()">åŠ å…¥åä½œ | Join</button>
            <span id="userInfo"></span>
        </div>
        <hr>
        <div id="mainArea" style="display:none;">
            <h4>å½“å‰é‡‡è´­æ¸…å• | Current Purchase List</h4>
            <form onsubmit="addItem(event)">
                <input id="itemName" placeholder="å•†å“åç§° | Name" required>
                <input id="itemQuantity" type="number" min="1" placeholder="æ•°é‡ | Qty" required style="width:70px;">
                <input id="itemPrice" type="number" min="0.01" step="0.01" placeholder="å•ä»· | Price" required style="width:90px;">
                <input id="itemLink" placeholder="å•†å“é“¾æ¥ | Link">
                <input id="itemPriority" placeholder="ä¼˜å…ˆçº§ | Priority" value="medium" style="width:80px;">
                <input id="itemNotes" placeholder="å¤‡æ³¨ | Notes">
                <button class="btn btn-primary" type="submit">æ·»åŠ  | Add</button>
                <button class="btn btn-warning" type="button" onclick="clearList()">æ¸…ç©º | Clear</button>
            </form>
            <table id="purchaseTable">
                <thead>
                    <tr>
                        <th>å•†å“åç§°</th><th>æ•°é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>å•†å“é“¾æ¥</th><th>ä¼˜å…ˆçº§</th><th>å¤‡æ³¨</th><th>æ·»åŠ äºº</th><th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div style="margin:10px 0;">
                <b>æ€»é‡‘é¢ | Total: <span id="totalAmount">0.00</span> å…ƒ</b>
            </div>
            <div>
                <b>å‘¨æœŸå¼€å§‹ | Period Start:</b> <span id="periodStart"></span>
                <b>ä¸‹æ¬¡å½’æ¡£ | Next Archive:</b> <span id="nextArchive"></span>
                <button class="btn btn-secondary" onclick="forceArchive()">ç«‹å³å½’æ¡£ | Archive Now</button>
            </div>
            <div style="margin-top:20px;">
                <button class="btn btn-primary" onclick="showArchivedLists()">ğŸ—‚ï¸ æŸ¥çœ‹å†å²é‡‡è´­åˆ—è¡¨ | View Archived Lists</button>
            </div>
        </div>
    </div>
    <!-- å†å²é‡‡è´­åˆ—è¡¨å¼¹çª— -->
    <div class="archived-modal" id="archivedListsArea">
        <div class="archived-modal-content">
            <button class="btn btn-secondary" onclick="closeArchivedListsView()">å…³é—­ | Close</button>
            <h4>å†å²é‡‡è´­åˆ—è¡¨ | Archived Purchase Lists</h4>
            <div id="archivedListsContent"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script>
        // ====== Firebase é…ç½®ä¸åˆå§‹åŒ– ======
        const firebaseConfig = {
            apiKey: "AIzaSyAxzDkV5O621f3pVKdQN7PZ9KPbLSljG5E",
            authDomain: "purchaselist-7891f.firebaseapp.com",
            databaseURL: "https://purchaselist-7891f-default-rtdb.firebaseio.com",
            projectId: "purchaselist-7891f",
            storageBucket: "purchaselist-7891f.firebasestorage.app",
            messagingSenderId: "887629105138",
            appId: "1:887629105138:web:1dd1c587684216721ccd6b",
            measurementId: "G-6BZB8CFNTZ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ====== å…¨å±€å˜é‡ ======
        let currentUser = null;
        let periodStart = null;
        let purchaseList = [];
        let archiveTimer = null;

        // ====== ç™»å½• ======
        function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) { alert('è¯·è¾“å…¥ç”¨æˆ·å'); return; }
            currentUser = username;
            document.getElementById('userInfo').textContent = `å½“å‰ç”¨æˆ·: ${username}`;
            document.getElementById('mainArea').style.display = '';
            loadCurrentList();
        }

        // ====== é‡‡è´­æ¸…å•æ“ä½œ ======
        function addItem(e) {
            e.preventDefault();
            if (!currentUser) return;
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const link = document.getElementById('itemLink').value.trim();
            const priority = document.getElementById('itemPriority').value.trim();
            const notes = document.getElementById('itemNotes').value.trim();
            if (!name || !quantity || !price) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
            const item = {
                name, quantity, price, total: +(quantity * price).toFixed(2), link, priority, notes,
                addedBy: currentUser, addedAt: dayjs().format('YYYY-MM-DD HH:mm:ss')
            };
            purchaseList.push(item);
            db.ref('purchaseList/current').set({
                items: purchaseList,
                periodStart: periodStart
            });
            clearForm();
        }

        function deleteItem(idx) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å•†å“ï¼Ÿ')) return;
            purchaseList.splice(idx, 1);
            db.ref('purchaseList/current').set({
                items: purchaseList,
                periodStart: periodStart
            });
        }

        function clearList() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºé‡‡è´­æ¸…å•ï¼Ÿ')) return;
            purchaseList = [];
            db.ref('purchaseList/current').set({
                items: [],
                periodStart: periodStart
            });
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemPriority').value = 'medium';
            document.getElementById('itemNotes').value = '';
        }

        // ====== å®æ—¶ç›‘å¬å½“å‰é‡‡è´­æ¸…å• ======
        function loadCurrentList() {
            db.ref('purchaseList/current').on('value', snapshot => {
                const data = snapshot.val();
                purchaseList = data && data.items ? data.items : [];
                periodStart = data && data.periodStart ? data.periodStart : dayjs().format('YYYY-MM-DD');
                renderPurchaseTable();
                updatePeriodStatus();
                checkAndAutoArchive();
            });
        }

        function renderPurchaseTable() {
            const tbody = document.querySelector('#purchaseTable tbody');
            tbody.innerHTML = '';
            let total = 0;
            purchaseList.forEach((item, idx) => {
                total += item.total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price}</td>
                    <td>${item.total}</td>
                    <td><a href="${item.link}" target="_blank">${item.link ? 'é“¾æ¥' : ''}</a></td>
                    <td>${item.priority}</td>
                    <td>${item.notes}</td>
                    <td>${item.addedBy}</td>
                    <td><button class="btn btn-danger" onclick="deleteItem(${idx})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        // ====== å‘¨æœŸå½’æ¡£ä¸çŠ¶æ€ ======
        function updatePeriodStatus() {
            document.getElementById('periodStart').textContent = periodStart;
            const nextArchive = dayjs(periodStart).add(14, 'day').format('YYYY-MM-DD');
            document.getElementById('nextArchive').textContent = nextArchive;
        }

        function checkAndAutoArchive() {
            if (!periodStart) return;
            const now = dayjs();
            const start = dayjs(periodStart);
            if (now.diff(start, 'day') >= 14) {
                forceArchive();
            }
        }

        function forceArchive() {
            if (purchaseList.length === 0) {
                // åªé‡ç½®å‘¨æœŸ
                periodStart = dayjs().format('YYYY-MM-DD');
                db.ref('purchaseList/current').set({ items: [], periodStart });
                return;
            }
            // å½’æ¡£
            const archiveId = Date.now();
            db.ref('purchaseList/history/' + archiveId).set({
                items: purchaseList,
                periodStart: periodStart,
                periodEnd: dayjs().format('YYYY-MM-DD'),
                archivedAt: dayjs().format('YYYY-MM-DD HH:mm:ss')
            }, () => {
                // æ¸…ç©ºå½“å‰
                periodStart = dayjs().format('YYYY-MM-DD');
                db.ref('purchaseList/current').set({ items: [], periodStart });
            });
        }

        // ====== å†å²é‡‡è´­åˆ—è¡¨ ======
        function showArchivedLists() {
            db.ref('purchaseList/history').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                const content = document.getElementById('archivedListsContent');
                content.innerHTML = '';
                const keys = Object.keys(data).sort((a, b) => b - a);
                if (keys.length === 0) {
                    content.innerHTML = '<div style="color:#888;">æš‚æ— å†å²é‡‡è´­åˆ—è¡¨</div>';
                } else {
                    keys.forEach((key, idx) => {
                        const period = data[key];
                        const div = document.createElement('div');
                        div.style = 'margin-bottom:18px; border-bottom:1px solid #eee; padding-bottom:10px;';
                        div.innerHTML = `<b>å‘¨æœŸ ${idx + 1}</b> <br>å¼€å§‹: ${period.periodStart}<br>ç»“æŸ: ${period.periodEnd}<br>å½’æ¡£æ—¶é—´: ${period.archivedAt}<br>å•†å“æ•°: ${period.items.length}<br><button class="btn btn-primary" onclick="viewArchivedTable('${key}')">æŸ¥çœ‹è¯¦æƒ…</button>`;
                        content.appendChild(div);
                    });
                }
                document.getElementById('archivedListsArea').style.display = 'block';
            });
        }

        function closeArchivedListsView() {
            document.getElementById('archivedListsArea').style.display = 'none';
        }

        function viewArchivedTable(key) {
            db.ref('purchaseList/history/' + key).once('value').then(snapshot => {
                const period = snapshot.val();
                let html = `<h4>å‘¨æœŸè¯¦æƒ…</h4><div>å¼€å§‹: ${period.periodStart}<br>ç»“æŸ: ${period.periodEnd}<br>å½’æ¡£æ—¶é—´: ${period.archivedAt}<br>å•†å“æ•°: ${period.items.length}</div><table border='1' style='width:100%;margin-top:10px;'><thead><tr><th>å•†å“åç§°</th><th>æ•°é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>å•†å“é“¾æ¥</th><th>ä¼˜å…ˆçº§</th><th>å¤‡æ³¨</th><th>æ·»åŠ äºº</th><th>æ·»åŠ æ—¶é—´</th></tr></thead><tbody>`;
                period.items.forEach(item => {
                    html += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${item.price}</td><td>${item.total}</td><td>${item.link}</td><td>${item.priority}</td><td>${item.notes}</td><td>${item.addedBy}</td><td>${item.addedAt}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('archivedListsContent').innerHTML = html;
            });
        }
    </script>
</body>
</html>