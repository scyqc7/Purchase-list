<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‡è´­å•è‡ªåŠ¨å¡«å†™ä¸å®¡æ ¸ - å¤šäººåœ¨çº¿åä½œç‰ˆ</title>
    <!-- SheetJS library for Excel generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Socket.IO for real-time collaboration -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1, h2 { text-align: center; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="number"], input[type="url"] {
            width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; margin-top: 15px; margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        .error { color: red; font-size: 0.9em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .section { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; }
        #totalPrice { font-weight: bold; color: green; }
        .item-row td:last-child { white-space: pre-wrap; word-break: break-all; } /* For remarks */
        
        /* å¤šäººåœ¨çº¿åä½œæ ·å¼ */
        .collaboration-panel {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .online-users {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
        }
        .user-badge {
            background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;
        }
        .user-badge.self { background: #007bff; }
        .edit-history {
            max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 4px;
        }
        .edit-entry {
            border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em;
        }
        .edit-entry:last-child { border-bottom: none; }
        .edit-time { color: #666; font-size: 0.8em; }
        .edit-user { font-weight: bold; color: #007bff; }
        .edit-action { color: #28a745; }
        .edit-item { color: #dc3545; }
        
        /* å®æ—¶ç¼–è¾‘æŒ‡ç¤ºå™¨ */
        .editing-indicator {
            position: fixed; top: 10px; right: 10px; background: #28a745; color: white; padding: 10px; border-radius: 5px; z-index: 1000;
        }
        .item-being-edited {
            background-color: #fff3cd; border: 2px solid #ffc107;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container { max-width: 100%; margin: 10px; }
            .online-users { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é‡‡è´­å•å¡«å†™ - å¤šäººåœ¨çº¿åä½œç‰ˆ</h1>
        
        <!-- å¤šäººåœ¨çº¿åä½œé¢æ¿ -->
        <div class="collaboration-panel">
            <h3>ğŸ”„ å¤šäººåœ¨çº¿åä½œ</h3>
            
            <!-- ç”¨æˆ·ç™»å½•åŒºåŸŸ -->
            <div id="loginArea">
                <label for="userName">æ‚¨çš„å§“å:</label>
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" style="width: 200px; margin-right: 10px;">
                <button type="button" onclick="loginUser()">åŠ å…¥åä½œ</button>
            </div>
            
            <!-- åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º -->
            <div id="onlineUsersArea" style="display: none;">
                <h4>ğŸ‘¥ åœ¨çº¿ç”¨æˆ· (<span id="userCount">0</span>)</h4>
                <div id="onlineUsers" class="online-users">
                    <!-- åœ¨çº¿ç”¨æˆ·å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <!-- ç¼–è¾‘å†å² -->
                <h4>ğŸ“ ç¼–è¾‘å†å²</h4>
                <div id="editHistory" class="edit-history">
                    <!-- ç¼–è¾‘è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <button type="button" onclick="logoutUser()" style="background-color: #dc3545;">é€€å‡ºåä½œ</button>
            </div>
        </div>
        
        <form id="purchaseForm">
            <label for="fillerName">å¡«å†™äºº:</label>
            <input type="text" id="fillerName" required>

            <label for="fillerEmail">å¡«å†™äººé‚®ç®±:</label>
            <input type="email" id="fillerEmail" required>

            <label for="productLink">å•†å“é“¾æ¥ (ç²˜è´´åè¯·æ‰‹åŠ¨å¡«å†™ä¸‹æ–¹ä¿¡æ¯):</label>
            <input type="url" id="productLink">
            <small>æ³¨æ„: è‡ªåŠ¨ä»é“¾æ¥è·å–ä¿¡æ¯åŠŸèƒ½å¤æ‚, æ­¤å¤„ä»…ä¿å­˜é“¾æ¥, è¯·æ‰‹åŠ¨å¡«å†™å•†å“è¯¦æƒ…ã€‚</small>

            <label for="productName">åç§°:</label>
            <input type="text" id="productName" required>

            <label for="productModel">å‹å·:</label>
            <input type="text" id="productModel">

            <label for="quantity">æ•°é‡:</label>
            <input type="number" id="quantity" min="1" required>

            <label for="unitPrice">å•ä»· (å…ƒ):</label>
            <input type="number" id="unitPrice" step="0.01" min="0" required>

            <label for="remarks">å•†å“å¤‡æ³¨:</label>
            <input type="text" id="remarks">

            <div>æ€»ä»·: <span id="totalPriceDisplay">0.00</span> å…ƒ</div>

            <button type="button" onclick="addItem()">æ·»åŠ å•†å“</button>
            <button type="button" onclick="generateExcel()">ç”Ÿæˆé‡‡è´­å• (Excel)</button>
            <button type="button" onclick="clearCurrentItems()">æ¸…ç©ºå½“å‰åˆ—è¡¨</button>
        </form>

        <h2>å½“å‰å¾…é‡‡è´­å•†å“åˆ—è¡¨</h2>
        <table id="currentItemsTable">
            <thead>
                <tr>
                    <th>å¡«å†™äºº</th>
                    <th>é‚®ç®±</th>
                    <th>åç§°</th>
                    <th>å‹å·</th>
                    <th>æ•°é‡</th>
                    <th>å•ä»·</th>
                    <th>é“¾æ¥</th>
                    <th>æ€»ä»·</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- Items will be added here -->
            </tbody>
        </table>

        <div class="section">
            <h2>é‡‡è´­å•å®¡æ ¸</h2>
            <p>ä¸Šä¼ éœ€è¦å®¡æ ¸çš„é‡‡è´­å• Excel æ–‡ä»¶ (é€šå¸¸æ˜¯ä¹‹å‰ç”Ÿæˆçš„ä»¥æ—¥æœŸå‘½åçš„æ–‡ä»¶)ã€‚</p>
            <label for="excelFileToApprove">é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œå®¡æ ¸:</label>
            <input type="file" id="excelFileToApprove" accept=".xlsx, .xls">
            <button type="button" onclick="loadExcelForApproval()">åŠ è½½å¹¶æ˜¾ç¤ºå¾…å®¡æ ¸é¡¹</button>

            <div id="approvalArea" style="display:none;">
                <h3>å¾…å®¡æ ¸å•†å“: <span id="approvalFileName"></span></h3>
                <table id="approvalTable">
                    <thead>
                        <tr>
                            <th>å®¡æ ¸ (å‹¾é€‰ä¸ºåŒæ„)</th>
                            <th>å¡«å†™äºº</th>
                            <th>é‚®ç®±</th>
                            <th>åç§°</th>
                            <th>å‹å·</th>
                            <th>æ•°é‡</th>
                            <th>å•ä»·</th>
                            <th>é“¾æ¥</th>
                            <th>æ€»ä»·</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Approval items will be loaded here -->
                    </tbody>
                </table>
                <button type="button" onclick="generateApprovedExcel()">ç”Ÿæˆå®¡æ ¸é€šè¿‡çš„é‡‡è´­å•</button>
            </div>
        </div>
    </div>

    <script>
        let purchaseItems = []; // Array to store current purchase items
        let itemsForApproval = []; // Array to store items loaded from Excel for approval
        
        // å¤šäººåœ¨çº¿åä½œå˜é‡
        let currentUser = null;
        let onlineUsers = [];
        let editHistory = [];
        let socket = null;
        let isCollaborationEnabled = false;

        // åˆå§‹åŒ–åä½œåŠŸèƒ½
        function initializeCollaboration() {
            // æ¨¡æ‹ŸWebSocketè¿æ¥ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦çœŸå®çš„åç«¯æœåŠ¡ï¼‰
            console.log('åä½œåŠŸèƒ½å·²åˆå§‹åŒ–');
            isCollaborationEnabled = true;
        }

        // ç”¨æˆ·ç™»å½•
        function loginUser() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                alert('è¯·è¾“å…¥æ‚¨çš„å§“å');
                return;
            }
            
            currentUser = {
                id: Date.now() + Math.random(),
                name: userName,
                joinTime: new Date()
            };
            
            // æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            if (!onlineUsers.find(user => user.id === currentUser.id)) {
                onlineUsers.push(currentUser);
            }
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('onlineUsersArea').style.display = 'block';
            updateOnlineUsersDisplay();
            
            // æ·»åŠ ç™»å½•è®°å½•
            addEditHistory('ç”¨æˆ·ç™»å½•', `${userName} åŠ å…¥äº†åä½œ`);
            
            // åˆå§‹åŒ–åä½œ
            initializeCollaboration();
        }

        // ç”¨æˆ·é€€å‡º
        function logoutUser() {
            if (currentUser) {
                addEditHistory('ç”¨æˆ·é€€å‡º', `${currentUser.name} é€€å‡ºäº†åä½œ`);
                onlineUsers = onlineUsers.filter(user => user.id !== currentUser.id);
                currentUser = null;
                
                // æ›´æ–°ç•Œé¢
                document.getElementById('loginArea').style.display = 'block';
                document.getElementById('onlineUsersArea').style.display = 'none';
                document.getElementById('userName').value = '';
            }
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º
        function updateOnlineUsersDisplay() {
            const usersContainer = document.getElementById('onlineUsers');
            const userCount = document.getElementById('userCount');
            
            usersContainer.innerHTML = '';
            userCount.textContent = onlineUsers.length;
            
            onlineUsers.forEach(user => {
                const userBadge = document.createElement('div');
                userBadge.className = `user-badge ${user.id === currentUser?.id ? 'self' : ''}`;
                userBadge.textContent = user.name;
                usersContainer.appendChild(userBadge);
            });
        }

        // æ·»åŠ ç¼–è¾‘å†å²è®°å½•
        function addEditHistory(action, description) {
            if (!currentUser) return;
            
            const editEntry = {
                id: Date.now(),
                user: currentUser.name,
                action: action,
                description: description,
                timestamp: new Date()
            };
            
            editHistory.unshift(editEntry);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (editHistory.length > 50) {
                editHistory = editHistory.slice(0, 50);
            }
            
            updateEditHistoryDisplay();
            
            // æ¨¡æ‹Ÿå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
            if (isCollaborationEnabled) {
                broadcastEdit(editEntry);
            }
        }

        // æ›´æ–°ç¼–è¾‘å†å²æ˜¾ç¤º
        function updateEditHistoryDisplay() {
            const historyContainer = document.getElementById('editHistory');
            historyContainer.innerHTML = '';
            
            editHistory.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'edit-entry';
                
                const timeStr = entry.timestamp.toLocaleTimeString();
                entryDiv.innerHTML = `
                    <span class="edit-time">${timeStr}</span> - 
                    <span class="edit-user">${entry.user}</span> 
                    <span class="edit-action">${entry.action}</span>: 
                    <span class="edit-item">${entry.description}</span>
                `;
                
                historyContainer.appendChild(entryDiv);
            });
        }

        // æ¨¡æ‹Ÿå¹¿æ’­ç¼–è¾‘æ“ä½œ
        function broadcastEdit(editEntry) {
            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡WebSocketå‘é€ç»™æœåŠ¡å™¨
            console.log('å¹¿æ’­ç¼–è¾‘æ“ä½œ:', editEntry);
            
            // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·æ¥æ”¶
            setTimeout(() => {
                if (onlineUsers.length > 1) {
                    // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·çš„æ“ä½œ
                    const otherUsers = onlineUsers.filter(user => user.id !== currentUser.id);
                    if (otherUsers.length > 0) {
                        const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
                        console.log(`${randomUser.name} æ”¶åˆ°äº†ç¼–è¾‘é€šçŸ¥`);
                    }
                }
            }, 100);
        }

        // å¢å¼ºçš„æ·»åŠ å•†å“åŠŸèƒ½
        function addItem() {
            const fillerName = document.getElementById('fillerName').value.trim();
            const fillerEmail = document.getElementById('fillerEmail').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const productModel = document.getElementById('productModel').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const productLink = document.getElementById('productLink').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            if (!fillerName || !fillerEmail || !productName || isNaN(quantity) || quantity <= 0 || isNaN(unitPrice) || unitPrice < 0) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ (å¡«å†™äºº, é‚®ç®±, åç§°, æ•°é‡, å•ä»·) å¹¶ç¡®ä¿æ•°å€¼æœ‰æ•ˆã€‚');
                return;
            }

            const totalPrice = parseFloat((quantity * unitPrice).toFixed(2));

            const item = {
                "å¡«å†™äºº": fillerName,
                "å¡«å†™äººé‚®ç®±": fillerEmail,
                "åç§°": productName,
                "å‹å·": productModel,
                "æ•°é‡": quantity,
                "å•ä»·": unitPrice,
                "é“¾æ¥": productLink,
                "æ€»ä»·": totalPrice,
                "å•†å“å¤‡æ³¨": remarks
            };

            purchaseItems.push(item);
            renderCurrentItemsTable();
            document.getElementById('purchaseForm').reset(); // Reset form fields
            document.getElementById('totalPriceDisplay').textContent = '0.00'; // Reset total price display
            
            // æ·»åŠ ç¼–è¾‘è®°å½•
            if (currentUser) {
                addEditHistory('æ·»åŠ å•†å“', `${productName} (æ•°é‡: ${quantity}, å•ä»·: ${unitPrice}å…ƒ)`);
            }
        }

        // å¢å¼ºçš„ç§»é™¤å•†å“åŠŸèƒ½
        function removeItem(index) {
            if (confirm('ç¡®å®šè¦ç§»é™¤æ­¤å•†å“å—?')) {
                const removedItem = purchaseItems[index];
                purchaseItems.splice(index, 1);
                renderCurrentItemsTable();
                
                // æ·»åŠ ç¼–è¾‘è®°å½•
                if (currentUser) {
                    addEditHistory('ç§»é™¤å•†å“', `${removedItem["åç§°"]} (åŸå¡«å†™äºº: ${removedItem["å¡«å†™äºº"]})`);
                }
            }
        }

        // å¢å¼ºçš„æ¸…ç©ºåˆ—è¡¨åŠŸèƒ½
        function clearCurrentItems() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰å¾…é‡‡è´­å•†å“å—? è¿™å°†æ¸…é™¤åˆ—è¡¨ä½†ä¸ä¼šå½±å“å·²ç”Ÿæˆçš„Excelæ–‡ä»¶ã€‚')) {
                const itemCount = purchaseItems.length;
                purchaseItems = [];
                renderCurrentItemsTable();
                
                // æ·»åŠ ç¼–è¾‘è®°å½•
                if (currentUser) {
                    addEditHistory('æ¸…ç©ºåˆ—è¡¨', `æ¸…ç©ºäº† ${itemCount} ä¸ªå•†å“`);
                }
            }
        }

        // å¢å¼ºçš„ç”ŸæˆExcelåŠŸèƒ½
        function generateExcel() {
            if (purchaseItems.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å•†å“ã€‚è¯·å…ˆæ·»åŠ å•†å“ã€‚');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(purchaseItems, {
                header: ["å¡«å†™äºº", "å¡«å†™äººé‚®ç®±", "åç§°", "å‹å·", "æ•°é‡", "å•ä»·", "é“¾æ¥", "æ€»ä»·", "å•†å“å¤‡æ³¨"]
            });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "é‡‡è´­å•");

            // Generate filename with current date
            const today = new Date();
            const dateString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            const fileName = `é‡‡è´­å•_${dateString}.xlsx`;

            XLSX.writeFile(workbook, fileName);
            alert(`é‡‡è´­å• "${fileName}" å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ã€‚\nè¯·æ³¨æ„ï¼šå½“å‰åˆ—è¡¨ä¸­çš„å•†å“å·²å¯¼å‡ºã€‚å¦‚éœ€å¼€å§‹æ–°çš„é‡‡è´­å‘¨æœŸï¼Œå»ºè®®å…ˆ"æ¸…ç©ºå½“å‰åˆ—è¡¨"ã€‚`);
            
            // æ·»åŠ ç¼–è¾‘è®°å½•
            if (currentUser) {
                addEditHistory('å¯¼å‡ºExcel', `å¯¼å‡ºäº† ${purchaseItems.length} ä¸ªå•†å“åˆ° ${fileName}`);
            }
        }

        // Update total price display
        document.getElementById('quantity').addEventListener('input', updateTotal);
        document.getElementById('unitPrice').addEventListener('input', updateTotal);

        function updateTotal() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const totalPrice = (quantity * unitPrice).toFixed(2);
            document.getElementById('totalPriceDisplay').textContent = totalPrice;
        }

        function renderCurrentItemsTable() {
            const tbody = document.getElementById('currentItemsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            purchaseItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.className = 'item-row';
                row.insertCell().textContent = item["å¡«å†™äºº"];
                row.insertCell().textContent = item["å¡«å†™äººé‚®ç®±"];
                row.insertCell().textContent = item["åç§°"];
                row.insertCell().textContent = item["å‹å·"];
                row.insertCell().textContent = item["æ•°é‡"];
                row.insertCell().textContent = item["å•ä»·"].toFixed(2);
                row.insertCell().textContent = item["é“¾æ¥"];
                row.insertCell().textContent = item["æ€»ä»·"].toFixed(2);
                row.insertCell().textContent = item["å•†å“å¤‡æ³¨"];
                
                const actionCell = row.insertCell();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'ç§»é™¤';
                removeButton.onclick = () => removeItem(index);
                actionCell.appendChild(removeButton);
            });
        }

        function loadExcelForApproval() {
            const fileInput = document.getElementById('excelFileToApprove');
            if (fileInput.files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶ã€‚');
                return;
            }
            const file = fileInput.files[0];
            document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶: ${file.name})`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    itemsForApproval = XLSX.utils.sheet_to_json(worksheet, { defval: "" }); // Use defval to handle empty cells

                    renderApprovalTable();
                    document.getElementById('approvalArea').style.display = 'block';
                    
                    // æ·»åŠ ç¼–è¾‘è®°å½•
                    if (currentUser) {
                        addEditHistory('ä¸Šä¼ å®¡æ ¸æ–‡ä»¶', `ä¸Šä¼ äº† ${file.name} è¿›è¡Œå®¡æ ¸`);
                    }
                } catch (error) {
                    console.error("Error reading Excel file:", error);
                    alert("æ— æ³•è¯»å–æˆ–è§£æExcelæ–‡ä»¶ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ä¸”æœªæŸåã€‚\né”™è¯¯: " + error.message);
                    document.getElementById('approvalArea').style.display = 'none';
                }
            };
            reader.onerror = function(e) {
                console.error("FileReader error:", e);
                alert("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚");
                document.getElementById('approvalArea').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        function renderApprovalTable() {
            const tbody = document.getElementById('approvalTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            itemsForApproval.forEach((item, index) => {
                const row = tbody.insertRow();
                const approvalCell = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `approve_${index}`;
                checkbox.checked = true; // Default to approved
                approvalCell.appendChild(checkbox);

                // Ensure all expected columns exist, even if empty in the Excel
                const expectedCols = ["å¡«å†™äºº", "å¡«å†™äººé‚®ç®±", "åç§°", "å‹å·", "æ•°é‡", "å•ä»·", "é“¾æ¥", "æ€»ä»·", "å•†å“å¤‡æ³¨"];
                expectedCols.forEach(colName => {
                    let cellValue = item[colName];
                    if (colName === "å•ä»·" || colName === "æ€»ä»·") {
                        cellValue = typeof cellValue === 'number' ? cellValue.toFixed(2) : (parseFloat(cellValue) || 0).toFixed(2);
                    } else if (colName === "æ•°é‡") {
                         cellValue = parseInt(cellValue) || 0;
                    }
                    row.insertCell().textContent = cellValue === undefined || cellValue === null ? "" : cellValue;
                });
            });
        }

        function generateApprovedExcel() {
            const approvedItems = [];
            itemsForApproval.forEach((item, index) => {
                const checkbox = document.getElementById(`approve_${index}`);
                if (checkbox && checkbox.checked) {
                    // Reconstruct item to ensure correct column order and data types
                    const approvedItem = {
                        "å¡«å†™äºº": item["å¡«å†™äºº"] || "",
                        "å¡«å†™äººé‚®ç®±": item["å¡«å†™äººé‚®ç®±"] || "",
                        "åç§°": item["åç§°"] || "",
                        "å‹å·": item["å‹å·"] || "",
                        "æ•°é‡": parseInt(item["æ•°é‡"]) || 0,
                        "å•ä»·": parseFloat(item["å•ä»·"]) || 0,
                        "é“¾æ¥": item["é“¾æ¥"] || "",
                        "æ€»ä»·": parseFloat(item["æ€»ä»·"]) || 0, // Recalculate or trust, here trusting
                        "å•†å“å¤‡æ³¨": item["å•†å“å¤‡æ³¨"] || ""
                    };
                    // Ensure total price is correct if values might have changed (or re-calculate)
                    approvedItem["æ€»ä»·"] = parseFloat((approvedItem["æ•°é‡"] * approvedItem["å•ä»·"]).toFixed(2));
                    approvedItems.push(approvedItem);
                }
            });

            if (approvedItems.length === 0) {
                alert('æ²¡æœ‰å‹¾é€‰ä»»ä½•å®¡æ ¸é€šè¿‡çš„å•†å“ã€‚');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(approvedItems, {
                header: ["å¡«å†™äºº", "å¡«å†™äººé‚®ç®±", "åç§°", "å‹å·", "æ•°é‡", "å•ä»·", "é“¾æ¥", "æ€»ä»·", "å•†å“å¤‡æ³¨"]
            });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "å®¡æ ¸é€šè¿‡é‡‡è´­å•");

            const today = new Date();
            const dateString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            const originalFileName = document.getElementById('excelFileToApprove').files[0]?.name.replace(/\.xlsx?$/, '') || 'é‡‡è´­å•';
            const fileName = `${originalFileName}_å®¡æ ¸é€šè¿‡_${dateString}.xlsx`;

            XLSX.writeFile(workbook, fileName);
            alert(`å®¡æ ¸é€šè¿‡çš„é‡‡è´­å• "${fileName}" å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ã€‚`);
            
            // æ·»åŠ ç¼–è¾‘è®°å½•
            if (currentUser) {
                addEditHistory('ç”Ÿæˆå®¡æ ¸Excel', `ç”Ÿæˆäº†å®¡æ ¸é€šè¿‡çš„Excelæ–‡ä»¶: ${fileName}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTotal(); // Calculate initial total price (0.00)
            console.log('é‡‡è´­å•ç®¡ç†ç³»ç»Ÿ - å¤šäººåœ¨çº¿åä½œç‰ˆå·²åŠ è½½');
        });
    </script>
</body>
</html>
