<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‡è´­å•è‡ªåŠ¨å¡«å†™ä¸å®¡æ ¸ - å¤šäººåœ¨çº¿åä½œç‰ˆ | Purchase Order Management System - Multi-user Collaboration</title>
    <!-- SheetJS library for Excel generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Socket.IO for real-time collaboration -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1, h2 { text-align: center; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="number"], input[type="url"] {
            width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; margin-top: 15px; margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        .error { color: red; font-size: 0.9em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .section { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; }
        #totalPrice { font-weight: bold; color: green; }
        .item-row td:last-child { white-space: pre-wrap; word-break: break-all; } /* For remarks */
        
        /* å¤šäººåœ¨çº¿åä½œæ ·å¼ */
        .collaboration-panel {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .online-users {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
        }
        .user-badge {
            background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;
        }
        .user-badge.self { background: #007bff; }
        .edit-history {
            max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 4px;
        }
        .edit-entry {
            border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em;
        }
        .edit-entry:last-child { border-bottom: none; }
        .edit-time { color: #666; font-size: 0.8em; }
        .edit-user { font-weight: bold; color: #007bff; }
        .edit-action { color: #28a745; }
        .edit-item { color: #dc3545; }
        
        /* å®æ—¶ç¼–è¾‘æŒ‡ç¤ºå™¨ */
        .editing-indicator {
            position: fixed; top: 10px; right: 10px; background: #28a745; color: white; padding: 10px; border-radius: 5px; z-index: 1000;
        }
        .item-being-edited {
            background-color: #fff3cd; border: 2px solid #ffc107;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container { max-width: 100%; margin: 10px; }
            .online-users { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é‡‡è´­å•å¡«å†™ - å¤šäººåœ¨çº¿åä½œç‰ˆ | Purchase Order - Multi-user Collaboration</h1>
        
        <!-- å¤šäººåœ¨çº¿åä½œé¢æ¿ -->
        <div class="collaboration-panel">
            <h3>ğŸ”„ å¤šäººåœ¨çº¿åä½œ | Multi-user Online Collaboration</h3>
            
            <!-- ç”¨æˆ·ç™»å½•åŒºåŸŸ -->
            <div id="loginArea">
                <label for="username">æ‚¨çš„å§“å | Your Name:</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å | Please enter your name">
                <label for="email">æ‚¨çš„é‚®ç®± | Your Email:</label>
                <input type="email" id="email" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®± | Please enter your email">
                <button type="button" onclick="login()">åŠ å…¥åä½œ | Join Collaboration</button>
            </div>
            
            <!-- åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º -->
            <div id="onlineUsersArea" style="display: none;">
                <h4>ğŸ‘¥ åœ¨çº¿ç”¨æˆ· | Online Users (<span id="userCount">0</span>)</h4>
                <div id="onlineUsers" class="online-users">
                    <!-- åœ¨çº¿ç”¨æˆ·å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <!-- å…±äº«å•†å“åˆ—è¡¨çŠ¶æ€ -->
                <h4>ğŸ“¦ å…±äº«å•†å“åˆ—è¡¨çŠ¶æ€ | Shared Items Status</h4>
                <div id="sharedItemsStatus" style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <div>å½“å‰å…±äº«å•†å“æ•°é‡ | Current Shared Items: <strong id="sharedItemCount">0</strong> ä¸ª</div>
                    <div>é‡‡è´­å•†å“ | Purchase Items: <span id="purchaseItemCount">0</span> ä¸ª</div>
                    <div>å®¡æ ¸å•†å“ | Approval Items: <span id="approvalItemCount">0</span> ä¸ª</div>
                    <div>å®¡æ ¸æ–‡ä»¶ | Approval File: <span id="approvalFileNameDisplay">æ— </span></div>
                    <div>æœ€åæ›´æ–°æ—¶é—´ | Last Update: <span id="lastUpdateTime">-</span></div>
                    <div>åä½œçŠ¶æ€ | Collaboration Status: <span id="collaborationStatus" style="color: #28a745;">ğŸŸ¢ å·²è¿æ¥</span></div>
                    <div>åŒæ­¥çŠ¶æ€ | Sync Status: <span id="syncStatus" style="color: #28a745;">ğŸ”„ å®æ—¶åŒæ­¥ä¸­</span></div>
                </div>
                
                <!-- é‡‡è´­å‘¨æœŸç®¡ç† -->
                <h4>ğŸ“… é‡‡è´­å‘¨æœŸç®¡ç† | Purchase Cycle Management</h4>
                <div id="periodStatus" style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <div>å½“å‰å‘¨æœŸå¼€å§‹ | Current Period Start: <span id="currentPeriodStart">-</span></div>
                    <div>ä¸‹æ¬¡æ›´æ–°æ—¶é—´ | Next Update Date: <span id="nextUpdateDate">-</span></div>
                    <div>ç¼–è¾‘çŠ¶æ€ | Edit Status: <span id="editingStatus" style="color: #28a745;">ğŸŸ¢ å…è®¸ç¼–è¾‘</span></div>
                    <div>å†å²è®°å½•æ•°é‡ | History Records: <span id="historyCount">0</span> ä¸ªå‘¨æœŸ</div>
                    <button type="button" onclick="viewPurchaseHistory()" style="background-color: #17a2b8; margin-top: 10px;">ğŸ“‹ æŸ¥çœ‹å†å²é‡‡è´­åˆ—è¡¨ | View History</button>
                    <button type="button" onclick="forceUpdatePeriod()" style="background-color: #ffc107; color: black; margin-top: 10px; margin-left: 10px;">ğŸ”„ å¼ºåˆ¶æ›´æ–°å‘¨æœŸ | Force Update</button>
                </div>
                
                <!-- ç¼–è¾‘å†å² -->
                <h4>ğŸ“ ç¼–è¾‘å†å² | Edit History</h4>
                <div id="editHistory" class="edit-history">
                    <!-- ç¼–è¾‘è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <button type="button" onclick="logoutUser()" style="background-color: #dc3545;">é€€å‡ºåä½œ | Logout</button>
            </div>
        </div>
        
        <form id="purchaseForm">
            <label for="itemName">å•†å“åç§° | Product Name:</label>
            <input type="text" id="itemName" required>

            <label for="itemQuantity">æ•°é‡ | Quantity:</label>
            <input type="number" id="itemQuantity" min="1" required>

            <label for="itemPrice">å•ä»· (å…ƒ) | Unit Price (CNY):</label>
            <input type="number" id="itemPrice" step="0.01" min="0" required>

            <label for="itemSupplier">ä¾›åº”å•† | Supplier:</label>
            <input type="text" id="itemSupplier" required>

            <label for="itemPriority">ä¼˜å…ˆçº§ | Priority:</label>
            <select id="itemPriority">
                <option value="low">ä½ | Low</option>
                <option value="medium" selected>ä¸­ | Medium</option>
                <option value="high">é«˜ | High</option>
            </select>

            <label for="itemNotes">å¤‡æ³¨ | Notes:</label>
            <input type="text" id="itemNotes">

            <button type="button" onclick="addItem()">æ·»åŠ å•†å“ | Add Item</button>
            <button type="button" onclick="generateExcel()">ç”Ÿæˆé‡‡è´­å• (Excel) | Generate Purchase Order (Excel)</button>
            <button type="button" onclick="clearCurrentList()">æ¸…ç©ºå½“å‰åˆ—è¡¨ | Clear Current List</button>
        </form>

        <h2>å½“å‰å¾…é‡‡è´­å•†å“åˆ—è¡¨ | Current Purchase Items List</h2>
        <table id="currentItemsTable">
            <thead>
                <tr>
                    <th>å•†å“åç§° | Product Name</th>
                    <th>æ•°é‡ | Quantity</th>
                    <th>å•ä»· | Unit Price</th>
                    <th>ä¾›åº”å•† | Supplier</th>
                    <th>ä¼˜å…ˆçº§ | Priority</th>
                    <th>å¤‡æ³¨ | Notes</th>
                    <th>æ·»åŠ äºº | Added By</th>
                    <th>æ·»åŠ æ—¶é—´ | Added At</th>
                    <th>æ“ä½œ | Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Items will be added here -->
            </tbody>
        </table>

        <div class="section">
            <h2>é‡‡è´­å•å®¡æ ¸ | Purchase Order Approval</h2>
            <p>ä¸Šä¼ éœ€è¦å®¡æ ¸çš„é‡‡è´­å• Excel æ–‡ä»¶ | Upload Excel file for approval (é€šå¸¸æ˜¯ä¹‹å‰ç”Ÿæˆçš„ä»¥æ—¥æœŸå‘½åçš„æ–‡ä»¶ | usually previously generated files with date names)ã€‚</p>
            <label for="excelFileToApprove">é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œå®¡æ ¸ | Select Excel file for approval:</label>
            <input type="file" id="excelFileToApprove" accept=".xlsx, .xls">
            <button type="button" onclick="loadExcelForApproval()">åŠ è½½å¹¶æ˜¾ç¤ºå¾…å®¡æ ¸é¡¹ | Load and Display Items for Approval</button>

            <div id="approvalArea" style="display:none;">
                <h3>å¾…å®¡æ ¸å•†å“ | Items for Approval: <span id="approvalFileName"></span></h3>
                <table id="approvalTable">
                    <thead>
                        <tr>
                            <th>å®¡æ ¸ (å‹¾é€‰ä¸ºåŒæ„) | Approval (Check to Approve)</th>
                            <th>å¡«å†™äºº | Filler Name</th>
                            <th>é‚®ç®± | Email</th>
                            <th>åç§° | Product Name</th>
                            <th>å‹å· | Model</th>
                            <th>æ•°é‡ | Quantity</th>
                            <th>å•ä»· | Unit Price</th>
                            <th>é“¾æ¥ | Link</th>
                            <th>æ€»ä»· | Total Price</th>
                            <th>å¤‡æ³¨ | Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Approval items will be loaded here -->
                    </tbody>
                </table>
                <button type="button" onclick="generateApprovedExcel()">ç”Ÿæˆå®¡æ ¸é€šè¿‡çš„é‡‡è´­å• | Generate Approved Purchase Order</button>
            </div>
        </div>

        <!-- å†å²é‡‡è´­åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="historyArea" style="display: none;" class="section">
            <h2>ğŸ“‹ å†å²é‡‡è´­åˆ—è¡¨ | Purchase History</h2>
            <div id="historyNavigation" style="margin-bottom: 20px;">
                <button type="button" onclick="closeHistoryView()" style="background-color: #6c757d;">è¿”å›å½“å‰åˆ—è¡¨ | Back to Current List</button>
                <span id="historyPeriodInfo" style="margin-left: 20px; font-weight: bold;"></span>
            </div>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>å•†å“åç§° | Product Name</th>
                        <th>æ•°é‡ | Quantity</th>
                        <th>å•ä»· | Unit Price</th>
                        <th>ä¾›åº”å•† | Supplier</th>
                        <th>ä¼˜å…ˆçº§ | Priority</th>
                        <th>å¤‡æ³¨ | Notes</th>
                        <th>æ·»åŠ äºº | Added By</th>
                        <th>æ·»åŠ æ—¶é—´ | Added At</th>
                        <th>æ€»ä»· | Total Price</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- å†å²å•†å“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let purchaseItems = []; // Array to store current purchase items
        let itemsForApproval = []; // Array to store items loaded from Excel for approval
        
        // å¤šäººåœ¨çº¿åä½œå˜é‡
        let currentUser = null;
        let onlineUsers = [];
        let editHistory = [];
        let socket = null;
        let isCollaborationEnabled = false;
        let sharedPurchaseItems = []; // å…±äº«çš„å•†å“åˆ—è¡¨
        let sharedApprovalItems = []; // å…±äº«çš„å®¡æ ¸å•†å“åˆ—è¡¨
        let sharedApprovalFileName = ''; // å…±äº«çš„å®¡æ ¸æ–‡ä»¶å
        
        // å†å²é‡‡è´­åˆ—è¡¨ç®¡ç†
        let purchaseHistory = []; // å†å²é‡‡è´­åˆ—è¡¨
        let currentPeriodStart = null; // å½“å‰å‘¨æœŸå¼€å§‹æ—¶é—´
        let nextUpdateDate = null; // ä¸‹æ¬¡æ›´æ–°æ—¶é—´
        let isEditingEnabled = true; // æ˜¯å¦å…è®¸ç¼–è¾‘
        
        // å®æ—¶åŒæ­¥é…ç½®
        let syncInterval = null;
        let lastSyncTime = 0;
        const SYNC_INTERVAL = 1000; // 1ç§’åŒæ­¥ä¸€æ¬¡

        // åˆå§‹åŒ–åä½œåŠŸèƒ½
        function initializeCollaboration() {
            console.log('åä½œåŠŸèƒ½å·²åˆå§‹åŒ–');
            isCollaborationEnabled = true;
            
            // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰
            initializeWebSocket();
            
            // ä»localStorageåŠ è½½å…±äº«æ•°æ®
            loadSharedData();
            
            // åˆå§‹åŒ–å…±äº«æ•°æ®
            if (sharedPurchaseItems.length === 0) {
                sharedPurchaseItems = [...purchaseItems];
                saveSharedData();
            } else {
                // åŒæ­¥å…¶ä»–ç”¨æˆ·çš„æ•°æ®
                purchaseItems = [...sharedPurchaseItems];
                renderCurrentItemsTable();
            }
            
            // åˆå§‹åŒ–å…±äº«å®¡æ ¸æ•°æ®
            if (sharedApprovalItems.length === 0) {
                sharedApprovalItems = [...itemsForApproval];
                saveSharedData();
            } else {
                // åŒæ­¥å…¶ä»–ç”¨æˆ·çš„å®¡æ ¸æ•°æ®
                itemsForApproval = [...sharedApprovalItems];
                if (itemsForApproval.length > 0) {
                    document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶ | file: ${sharedApprovalFileName})`;
                    document.getElementById('approvalArea').style.display = 'block';
                    renderApprovalTable();
                }
            }
            
            // åˆå§‹åŒ–é‡‡è´­å‘¨æœŸ
            initializePurchasePeriod();
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateSharedItemsStatus();
            
            // å¯åŠ¨å®æ—¶åŒæ­¥
            startRealTimeSync();
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
        function initializeWebSocket() {
            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šè¿æ¥åˆ°çœŸå®çš„WebSocketæœåŠ¡å™¨
            console.log('WebSocketè¿æ¥å·²åˆå§‹åŒ–ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰');
            
            // æ¨¡æ‹ŸWebSocketäº‹ä»¶ç›‘å¬
            window.addEventListener('storage', function(e) {
                if (e.key === 'sharedPurchaseData' && e.newValue) {
                    handleDataUpdate(e.newValue);
                }
            });
        }

        // å¯åŠ¨å®æ—¶åŒæ­¥
        function startRealTimeSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                if (isCollaborationEnabled && currentUser) {
                    performRealTimeSync();
                }
            }, SYNC_INTERVAL);
        }

        // æ‰§è¡Œå®æ—¶åŒæ­¥
        function performRealTimeSync() {
            const currentTime = Date.now();
            if (currentTime - lastSyncTime >= SYNC_INTERVAL) {
                // æ£€æŸ¥æ•°æ®æ›´æ–°
                checkForDataUpdates();
                
                // å¹¿æ’­å¿ƒè·³
                broadcastHeartbeat();
                
                lastSyncTime = currentTime;
            }
        }

        // å¤„ç†æ•°æ®æ›´æ–°
        function handleDataUpdate(newData) {
            try {
                const data = JSON.parse(newData);
                const updateTime = data.lastUpdate || 0;
                const currentLastUpdate = localStorage.getItem('lastDataUpdate') || '0';
                
                // å¦‚æœå‘ç°æ–°çš„æ›´æ–°
                if (updateTime > parseInt(currentLastUpdate)) {
                    console.log('æ”¶åˆ°å®æ—¶æ•°æ®æ›´æ–°:', data);
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    sharedPurchaseItems = data.purchaseItems || [];
                    sharedApprovalItems = data.approvalItems || [];
                    sharedApprovalFileName = data.approvalFileName || '';
                    
                    // åŒæ­¥åˆ°å½“å‰ç”¨æˆ·ç•Œé¢
                    purchaseItems = [...sharedPurchaseItems];
                    itemsForApproval = [...sharedApprovalItems];
                    
                    // æ›´æ–°æ˜¾ç¤º
                    renderCurrentItemsTable();
                    if (itemsForApproval.length > 0) {
                        document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶ | file: ${sharedApprovalFileName})`;
                        document.getElementById('approvalArea').style.display = 'block';
                        renderApprovalTable();
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    updateSharedItemsStatus();
                    
                    // è®°å½•æœ€åæ›´æ–°æ—¶é—´
                    localStorage.setItem('lastDataUpdate', updateTime.toString());
                    
                    // æ·»åŠ åŒæ­¥è®°å½•
                    if (data.updateUser && data.updateUser !== currentUser?.name) {
                        addEditHistory('å®æ—¶åŒæ­¥ | Real-time Sync', `åŒæ­¥äº† | synced ${data.updateUser} çš„æ›´æ–° | updates`);
                    }
                }
            } catch (error) {
                console.error('å¤„ç†æ•°æ®æ›´æ–°å¤±è´¥:', error);
            }
        }

        // å¹¿æ’­å¿ƒè·³
        function broadcastHeartbeat() {
            if (currentUser) {
                const heartbeat = {
                    type: 'heartbeat',
                    user: currentUser.name,
                    timestamp: Date.now()
                };
                
                // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡WebSocketå‘é€
                console.log('å‘é€å¿ƒè·³:', heartbeat);
            }
        }

        // ç”¨æˆ·ç™»å½•
        function login() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!username || !email) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œé‚®ç®± | Please enter username and email');
                return;
            }
            
            currentUser = { name: username, email: email };
            
            // æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            if (!onlineUsers.find(user => user.name === username)) {
                onlineUsers.push(currentUser);
            }
            
            // å®æ—¶åŒæ­¥ç”¨æˆ·çŠ¶æ€
            if (isCollaborationEnabled) {
                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
                addEditHistory('ç”¨æˆ·ç™»å½• | User Login', `${username} å·²ç™»å½• | logged in`);
            }
            
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('collaborationArea').style.display = 'block';
            document.getElementById('userInfo').textContent = `å½“å‰ç”¨æˆ· | Current User: ${username}`;
            
            updateOnlineUsersDisplay();
        }

        // ç”¨æˆ·é€€å‡º
        function logoutUser() {
            if (currentUser) {
                addEditHistory('ç”¨æˆ·é€€å‡º | User Logout', `${currentUser.name} é€€å‡ºäº†åä½œ | left collaboration`);
                onlineUsers = onlineUsers.filter(user => user.name !== currentUser.name);
                currentUser = null;
                
                // æ›´æ–°ç•Œé¢
                document.getElementById('loginArea').style.display = 'block';
                document.getElementById('onlineUsersArea').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('email').value = '';
            }
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º
        function updateOnlineUsersDisplay() {
            const usersContainer = document.getElementById('onlineUsers');
            const userCount = document.getElementById('userCount');
            
            usersContainer.innerHTML = '';
            userCount.textContent = onlineUsers.length;
            
            onlineUsers.forEach(user => {
                const userBadge = document.createElement('div');
                userBadge.className = `user-badge ${user.name === currentUser?.name ? 'self' : ''}`;
                userBadge.textContent = user.name;
                usersContainer.appendChild(userBadge);
            });
        }

        // æ·»åŠ ç¼–è¾‘å†å²è®°å½•
        function addEditHistory(action, description) {
            if (!currentUser) return;
            
            const editEntry = {
                id: Date.now(),
                user: currentUser.name,
                action: action,
                description: description,
                timestamp: new Date()
            };
            
            editHistory.unshift(editEntry);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (editHistory.length > 50) {
                editHistory = editHistory.slice(0, 50);
            }
            
            updateEditHistoryDisplay();
            
            // æ¨¡æ‹Ÿå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
            if (isCollaborationEnabled) {
                broadcastEdit(editEntry);
            }
        }

        // æ›´æ–°ç¼–è¾‘å†å²æ˜¾ç¤º
        function updateEditHistoryDisplay() {
            const historyContainer = document.getElementById('editHistory');
            historyContainer.innerHTML = '';
            
            editHistory.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'edit-entry';
                
                const timeStr = entry.timestamp.toLocaleTimeString();
                entryDiv.innerHTML = `
                    <span class="edit-time">${timeStr}</span> - 
                    <span class="edit-user">${entry.user}</span> 
                    <span class="edit-action">${entry.action}</span>: 
                    <span class="edit-item">${entry.description}</span>
                `;
                
                historyContainer.appendChild(entryDiv);
            });
        }

        // æ›´æ–°å…±äº«å•†å“åˆ—è¡¨çŠ¶æ€æ˜¾ç¤º
        function updateSharedItemsStatus() {
            const sharedItemCount = document.getElementById('sharedItemCount');
            const purchaseItemCount = document.getElementById('purchaseItemCount');
            const approvalItemCount = document.getElementById('approvalItemCount');
            const approvalFileNameDisplay = document.getElementById('approvalFileNameDisplay');
            const lastUpdateTime = document.getElementById('lastUpdateTime');
            const collaborationStatus = document.getElementById('collaborationStatus');
            const syncStatus = document.getElementById('syncStatus');
            
            if (sharedItemCount) {
                const totalItems = sharedPurchaseItems.length + sharedApprovalItems.length;
                sharedItemCount.textContent = totalItems;
            }
            
            if (purchaseItemCount) {
                purchaseItemCount.textContent = sharedPurchaseItems.length;
            }
            
            if (approvalItemCount) {
                approvalItemCount.textContent = sharedApprovalItems.length;
            }
            
            if (approvalFileNameDisplay) {
                approvalFileNameDisplay.textContent = sharedApprovalFileName || 'æ— ';
            }
            
            if (lastUpdateTime) {
                lastUpdateTime.textContent = new Date().toLocaleTimeString();
            }
            
            if (collaborationStatus) {
                if (isCollaborationEnabled && currentUser) {
                    collaborationStatus.innerHTML = 'ğŸŸ¢ å·²è¿æ¥';
                    collaborationStatus.style.color = '#28a745';
                } else {
                    collaborationStatus.innerHTML = 'ğŸ”´ æœªè¿æ¥';
                    collaborationStatus.style.color = '#dc3545';
                }
            }
            
            if (syncStatus) {
                if (isCollaborationEnabled && currentUser) {
                    syncStatus.innerHTML = 'ğŸ”„ å®æ—¶åŒæ­¥ä¸­';
                    syncStatus.style.color = '#28a745';
                } else {
                    syncStatus.innerHTML = 'â¸ï¸ åŒæ­¥å·²æš‚åœ';
                    syncStatus.style.color = '#ffc107';
                }
            }
        }

        // åŒæ­¥å®¡æ ¸å•†å“åˆ—è¡¨åˆ°æ‰€æœ‰ç”¨æˆ·
        function syncApprovalItems() {
            if (isCollaborationEnabled) {
                sharedApprovalItems = [...itemsForApproval];
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateSharedItemsStatus();
                // ä¿å­˜åˆ°localStorage
                saveSharedData();
                // è®°å½•æ›´æ–°æ—¶é—´
                localStorage.setItem('lastDataUpdate', Date.now().toString());
                // æ¨¡æ‹Ÿå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
                broadcastApprovalItemsUpdate();
            }
        }

        // æ¨¡æ‹Ÿå¹¿æ’­å®¡æ ¸å•†å“åˆ—è¡¨æ›´æ–°
        function broadcastApprovalItemsUpdate() {
            console.log('å¹¿æ’­å®¡æ ¸å•†å“åˆ—è¡¨æ›´æ–°:', sharedApprovalItems);
            
            // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·æ¥æ”¶æ›´æ–°
            setTimeout(() => {
                if (onlineUsers.length > 1) {
                    const otherUsers = onlineUsers.filter(user => user.name !== currentUser.name);
                    if (otherUsers.length > 0) {
                        otherUsers.forEach(user => {
                            console.log(`${user.name} æ”¶åˆ°äº†å®¡æ ¸å•†å“åˆ—è¡¨æ›´æ–°`);
                            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡WebSocketå‘é€æ•°æ®
                        });
                    }
                }
            }, 100);
        }

        // åŒæ­¥å•†å“åˆ—è¡¨åˆ°æ‰€æœ‰ç”¨æˆ·
        function syncPurchaseItems() {
            if (isCollaborationEnabled) {
                sharedPurchaseItems = [...purchaseItems];
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateSharedItemsStatus();
                // ä¿å­˜åˆ°localStorage
                saveSharedData();
                // è®°å½•æ›´æ–°æ—¶é—´
                localStorage.setItem('lastDataUpdate', Date.now().toString());
                // æ¨¡æ‹Ÿå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
                broadcastPurchaseItemsUpdate();
            }
        }

        // æ¨¡æ‹Ÿå¹¿æ’­å•†å“åˆ—è¡¨æ›´æ–°
        function broadcastPurchaseItemsUpdate() {
            console.log('å¹¿æ’­å•†å“åˆ—è¡¨æ›´æ–°:', sharedPurchaseItems);
            
            // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·æ¥æ”¶æ›´æ–°
            setTimeout(() => {
                if (onlineUsers.length > 1) {
                    const otherUsers = onlineUsers.filter(user => user.name !== currentUser.name);
                    if (otherUsers.length > 0) {
                        otherUsers.forEach(user => {
                            console.log(`${user.name} æ”¶åˆ°äº†å•†å“åˆ—è¡¨æ›´æ–°`);
                            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡WebSocketå‘é€æ•°æ®
                        });
                    }
                }
            }, 100);
        }

        // æ¨¡æ‹Ÿå¹¿æ’­ç¼–è¾‘æ“ä½œ
        function broadcastEdit(editEntry) {
            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šé€šè¿‡WebSocketå‘é€ç»™æœåŠ¡å™¨
            console.log('å¹¿æ’­ç¼–è¾‘æ“ä½œ:', editEntry);
            
            // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·æ¥æ”¶
            setTimeout(() => {
                if (onlineUsers.length > 1) {
                    // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·çš„æ“ä½œ
                    const otherUsers = onlineUsers.filter(user => user.name !== currentUser.name);
                    if (otherUsers.length > 0) {
                        const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
                        console.log(`${randomUser.name} æ”¶åˆ°äº†ç¼–è¾‘é€šçŸ¥`);
                    }
                }
            }, 100);
        }

        // æ·»åŠ å•†å“åˆ°åˆ—è¡¨
        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 0;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const supplier = document.getElementById('itemSupplier').value.trim();
            const priority = document.getElementById('itemPriority').value;
            const notes = document.getElementById('itemNotes').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å•†å“åç§° | Please enter item name');
                return;
            }

            if (quantity <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ | Please enter valid quantity');
                return;
            }

            if (price <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ | Please enter valid price');
                return;
            }

            if (!supplier) {
                alert('è¯·è¾“å…¥ä¾›åº”å•†ä¿¡æ¯ | Please enter supplier information');
                return;
            }

            const newItem = {
                id: Date.now(),
                name: name,
                quantity: quantity,
                price: price,
                supplier: supplier,
                priority: priority,
                notes: notes,
                addedBy: currentUser?.name || 'Unknown',
                addedAt: new Date().toLocaleString('zh-CN')
            };

            purchaseItems.push(newItem);
            
            // å®æ—¶åŒæ­¥åˆ°å…±äº«æ•°æ®
            if (isCollaborationEnabled) {
                sharedPurchaseItems = [...purchaseItems];
                saveSharedData();
                addEditHistory('æ·»åŠ å•†å“ | Add Item', `${currentUser?.name || 'Unknown'} æ·»åŠ äº† | added ${name}`);
            }

            renderCurrentItemsTable();
            clearForm();
            updateSharedItemsStatus();
        }

        // åˆ é™¤å•†å“
        function deleteItem(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ | Are you sure you want to delete this item?')) {
                const deletedItem = purchaseItems[index];
                purchaseItems.splice(index, 1);
                
                // å®æ—¶åŒæ­¥åˆ°å…±äº«æ•°æ®
                if (isCollaborationEnabled) {
                    sharedPurchaseItems = [...purchaseItems];
                    saveSharedData();
                    addEditHistory('åˆ é™¤å•†å“ | Delete Item', `${currentUser?.name || 'Unknown'} åˆ é™¤äº† | deleted ${deletedItem.name}`);
                }
                
                renderCurrentItemsTable();
                updateSharedItemsStatus();
            }
        }

        // æ¸…ç©ºå½“å‰åˆ—è¡¨
        function clearCurrentList() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰åˆ—è¡¨å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å•†å“ã€‚ | Are you sure you want to clear the current list? This will delete all items.')) {
                // ä¿å­˜åˆ°å†å²è®°å½•
                if (purchaseItems.length > 0) {
                    const historyEntry = {
                        period: currentPeriodStart,
                        items: [...purchaseItems],
                        clearedBy: currentUser?.name || 'Unknown',
                        clearedAt: new Date().toLocaleString('zh-CN')
                    };
                    purchaseHistory.push(historyEntry);
                    localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
                }
                
                purchaseItems = [];
                
                // å®æ—¶åŒæ­¥åˆ°å…±äº«æ•°æ®
                if (isCollaborationEnabled) {
                    sharedPurchaseItems = [];
                    saveSharedData();
                    addEditHistory('æ¸…ç©ºåˆ—è¡¨ | Clear List', `${currentUser?.name || 'Unknown'} æ¸…ç©ºäº†å½“å‰åˆ—è¡¨ | cleared current list`);
                }
                
                renderCurrentItemsTable();
                updateSharedItemsStatus();
            }
        }

        // ç”ŸæˆExcelæ–‡ä»¶
        function generateExcel() {
            if (purchaseItems.length === 0) {
                alert('æ²¡æœ‰å•†å“å¯ä»¥å¯¼å‡º | No items to export');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(purchaseItems);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "é‡‡è´­æ¸…å• | Purchase List");
            
            // ç”Ÿæˆæ–‡ä»¶å
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const fileName = `é‡‡è´­æ¸…å•_${timestamp}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            
            // å°†æ•°æ®æ·»åŠ åˆ°å®¡æ ¸åˆ—è¡¨
            itemsForApproval = [...purchaseItems];
            sharedApprovalFileName = fileName;
            
            // å®æ—¶åŒæ­¥å®¡æ ¸æ•°æ®
            if (isCollaborationEnabled) {
                sharedApprovalItems = [...itemsForApproval];
                saveSharedData();
                addEditHistory('ç”ŸæˆExcel | Generate Excel', `${currentUser?.name || 'Unknown'} ç”Ÿæˆäº† | generated ${fileName}`);
            }
            
            // æ˜¾ç¤ºå®¡æ ¸åŒºåŸŸ
            document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶ | file: ${fileName})`;
            document.getElementById('approvalArea').style.display = 'block';
            renderApprovalTable();
            
            alert(`Excelæ–‡ä»¶å·²ç”Ÿæˆ: ${fileName} | Excel file generated: ${fileName}`);
        }

        // Update total price display
        document.getElementById('quantity').addEventListener('input', updateTotal);
        document.getElementById('unitPrice').addEventListener('input', updateTotal);

        function updateTotal() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const totalPrice = (quantity * unitPrice).toFixed(2);
            document.getElementById('totalPriceDisplay').textContent = totalPrice;
        }

        function renderCurrentItemsTable() {
            const tbody = document.getElementById('currentItemsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            purchaseItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.className = 'item-row';
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = item.price.toFixed(2);
                row.insertCell().textContent = item.supplier;
                row.insertCell().textContent = item.priority;
                row.insertCell().textContent = item.notes;
                row.insertCell().textContent = item.addedBy;
                row.insertCell().textContent = item.addedAt;
                
                const actionCell = row.insertCell();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'ç§»é™¤';
                removeButton.onclick = () => deleteItem(index);
                actionCell.appendChild(removeButton);
            });
        }

        function loadExcelForApproval() {
            const fileInput = document.getElementById('excelFileToApprove');
            if (fileInput.files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶ã€‚ | Please select an Excel file first.');
                return;
            }
            const file = fileInput.files[0];
            document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶ | file: ${file.name})`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    itemsForApproval = XLSX.utils.sheet_to_json(worksheet, { defval: "" }); // Use defval to handle empty cells

                    renderApprovalTable();
                    document.getElementById('approvalArea').style.display = 'block';
                    
                    // åŒæ­¥å®¡æ ¸å•†å“åˆ°æ‰€æœ‰ç”¨æˆ·
                    sharedApprovalFileName = file.name;
                    syncApprovalItems();
                    
                    // æ·»åŠ ç¼–è¾‘è®°å½•
                    if (currentUser) {
                        addEditHistory('ä¸Šä¼ å®¡æ ¸æ–‡ä»¶ | Upload Approval File', `ä¸Šä¼ äº† | uploaded ${file.name} è¿›è¡Œå®¡æ ¸ | for approval (${itemsForApproval.length} ä¸ªå•†å“ | items)`);
                    }
                } catch (error) {
                    console.error("Error reading Excel file:", error);
                    alert("æ— æ³•è¯»å–æˆ–è§£æExcelæ–‡ä»¶ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ä¸”æœªæŸåã€‚\né”™è¯¯ | Error: " + error.message + "\nUnable to read or parse Excel file. Please ensure the file format is correct and not corrupted.");
                    document.getElementById('approvalArea').style.display = 'none';
                }
            };
            reader.onerror = function(e) {
                console.error("FileReader error:", e);
                alert("è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚ | Error occurred while reading file.");
                document.getElementById('approvalArea').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        function renderApprovalTable() {
            const tbody = document.getElementById('approvalTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            itemsForApproval.forEach((item, index) => {
                const row = tbody.insertRow();
                const approvalCell = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `approve_${index}`;
                checkbox.checked = true; // Default to approved
                approvalCell.appendChild(checkbox);

                // Ensure all expected columns exist, even if empty in the Excel
                const expectedCols = ["å¡«å†™äºº", "å¡«å†™äººé‚®ç®±", "åç§°", "å‹å·", "æ•°é‡", "å•ä»·", "é“¾æ¥", "æ€»ä»·", "å•†å“å¤‡æ³¨"];
                expectedCols.forEach(colName => {
                    let cellValue = item[colName];
                    if (colName === "å•ä»·" || colName === "æ€»ä»·") {
                        cellValue = typeof cellValue === 'number' ? cellValue.toFixed(2) : (parseFloat(cellValue) || 0).toFixed(2);
                    } else if (colName === "æ•°é‡") {
                         cellValue = parseInt(cellValue) || 0;
                    }
                    row.insertCell().textContent = cellValue === undefined || cellValue === null ? "" : cellValue;
                });
            });
        }

        function generateApprovedExcel() {
            const approvedItems = [];
            itemsForApproval.forEach((item, index) => {
                const checkbox = document.getElementById(`approve_${index}`);
                if (checkbox && checkbox.checked) {
                    // Reconstruct item to ensure correct column order and data types
                    const approvedItem = {
                        "å¡«å†™äºº": item["å¡«å†™äºº"] || "",
                        "å¡«å†™äººé‚®ç®±": item["å¡«å†™äººé‚®ç®±"] || "",
                        "åç§°": item["åç§°"] || "",
                        "å‹å·": item["å‹å·"] || "",
                        "æ•°é‡": parseInt(item["æ•°é‡"]) || 0,
                        "å•ä»·": parseFloat(item["å•ä»·"]) || 0,
                        "é“¾æ¥": item["é“¾æ¥"] || "",
                        "æ€»ä»·": parseFloat(item["æ€»ä»·"]) || 0, // Recalculate or trust, here trusting
                        "å•†å“å¤‡æ³¨": item["å•†å“å¤‡æ³¨"] || ""
                    };
                    // Ensure total price is correct if values might have changed (or re-calculate)
                    approvedItem["æ€»ä»·"] = parseFloat((approvedItem["æ•°é‡"] * approvedItem["å•ä»·"]).toFixed(2));
                    approvedItems.push(approvedItem);
                }
            });

            if (approvedItems.length === 0) {
                alert('æ²¡æœ‰å‹¾é€‰ä»»ä½•å®¡æ ¸é€šè¿‡çš„å•†å“ã€‚ | No approved items selected.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(approvedItems, {
                header: ["å¡«å†™äºº", "å¡«å†™äººé‚®ç®±", "åç§°", "å‹å·", "æ•°é‡", "å•ä»·", "é“¾æ¥", "æ€»ä»·", "å•†å“å¤‡æ³¨"]
            });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "å®¡æ ¸é€šè¿‡é‡‡è´­å•");

            const today = new Date();
            const dateString = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            const originalFileName = document.getElementById('excelFileToApprove').files[0]?.name.replace(/\.xlsx?$/, '') || 'é‡‡è´­å•';
            const fileName = `${originalFileName}_å®¡æ ¸é€šè¿‡_${dateString}.xlsx`;

            XLSX.writeFile(workbook, fileName);
            alert(`å®¡æ ¸é€šè¿‡çš„é‡‡è´­å• "${fileName}" å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ã€‚ | Approved purchase order "${fileName}" has been generated and download started.`);
            
            // æ·»åŠ ç¼–è¾‘è®°å½•
            if (currentUser) {
                addEditHistory('ç”Ÿæˆå®¡æ ¸Excel | Generate Approval Excel', `ç”Ÿæˆäº†å®¡æ ¸é€šè¿‡çš„Excelæ–‡ä»¶ | generated approved Excel file: ${fileName} (${approvedItems.length} ä¸ªå•†å“ | items)`);
            }
        }

        // åˆå§‹åŒ–é‡‡è´­å‘¨æœŸ
        function initializePurchasePeriod() {
            const now = new Date();
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®å‘¨æœŸå¼€å§‹æ—¶é—´ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´
            if (!currentPeriodStart) {
                currentPeriodStart = new Date(now);
                localStorage.setItem('currentPeriodStart', currentPeriodStart.toISOString());
            } else {
                currentPeriodStart = new Date(currentPeriodStart);
            }
            
            // è®¡ç®—ä¸‹æ¬¡æ›´æ–°æ—¶é—´ï¼ˆä¸¤å‘¨åï¼‰
            nextUpdateDate = new Date(currentPeriodStart);
            nextUpdateDate.setDate(nextUpdateDate.getDate() + 14);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å‘¨æœŸ
            if (now >= nextUpdateDate) {
                updatePurchasePeriod();
            }
            
            // åŠ è½½å†å²è®°å½•
            loadPurchaseHistory();
            
            // æ›´æ–°å‘¨æœŸçŠ¶æ€æ˜¾ç¤º
            updatePeriodStatus();
        }

        // æ›´æ–°é‡‡è´­å‘¨æœŸ
        function updatePurchasePeriod() {
            if (purchaseItems.length > 0) {
                // ä¿å­˜å½“å‰å‘¨æœŸåˆ°å†å²è®°å½•
                const periodRecord = {
                    id: Date.now(),
                    periodStart: currentPeriodStart,
                    periodEnd: new Date(),
                    items: [...purchaseItems],
                    totalItems: purchaseItems.length,
                    totalValue: purchaseItems.reduce((sum, item) => sum + (item.quantity * item.price), 0)
                };
                
                purchaseHistory.unshift(periodRecord);
                localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
                
                // æ·»åŠ ç¼–è¾‘è®°å½•
                if (currentUser) {
                    addEditHistory('å‘¨æœŸæ›´æ–° | Cycle Update', `ä¿å­˜äº† | saved ${purchaseItems.length} ä¸ªå•†å“åˆ°å†å²è®°å½• | items to history`);
                }
            }
            
            // æ¸…ç©ºå½“å‰åˆ—è¡¨
            purchaseItems = [];
            sharedPurchaseItems = [];
            
            // è®¾ç½®æ–°çš„å‘¨æœŸå¼€å§‹æ—¶é—´
            currentPeriodStart = new Date();
            nextUpdateDate = new Date(currentPeriodStart);
            nextUpdateDate.setDate(nextUpdateDate.getDate() + 14);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('currentPeriodStart', currentPeriodStart.toISOString());
            localStorage.setItem('nextUpdateDate', nextUpdateDate.toISOString());
            
            // æ›´æ–°æ˜¾ç¤º
            renderCurrentItemsTable();
            updatePeriodStatus();
            updateSharedItemsStatus();
        }

        // å¼ºåˆ¶æ›´æ–°å‘¨æœŸ
        function forceUpdatePeriod() {
            if (confirm('ç¡®å®šè¦å¼ºåˆ¶æ›´æ–°é‡‡è´­å‘¨æœŸå—ï¼Ÿå½“å‰çš„å•†å“åˆ—è¡¨å°†è¢«ä¿å­˜åˆ°å†å²è®°å½•ä¸­ã€‚ | Are you sure to force update the purchase cycle? Current items will be saved to history.')) {
                updatePurchasePeriod();
                if (currentUser) {
                    addEditHistory('å¼ºåˆ¶æ›´æ–°å‘¨æœŸ | Force Update Cycle', 'ç®¡ç†å‘˜å¼ºåˆ¶æ›´æ–°äº†é‡‡è´­å‘¨æœŸ | Admin forced cycle update');
                }
            }
        }

        // åŠ è½½å†å²è®°å½•
        function loadPurchaseHistory() {
            const savedHistory = localStorage.getItem('purchaseHistory');
            if (savedHistory) {
                purchaseHistory = JSON.parse(savedHistory);
                // è½¬æ¢æ—¥æœŸå­—ç¬¦ä¸²ä¸ºDateå¯¹è±¡
                purchaseHistory.forEach(record => {
                    record.periodStart = new Date(record.periodStart);
                    record.periodEnd = new Date(record.periodEnd);
                });
            }
        }

        // æŸ¥çœ‹å†å²é‡‡è´­åˆ—è¡¨
        function viewPurchaseHistory() {
            if (purchaseHistory.length === 0) {
                alert('æš‚æ— å†å²é‡‡è´­è®°å½• | No purchase history records');
                return;
            }
            
            // æ˜¾ç¤ºå†å²è®°å½•é€‰æ‹©ç•Œé¢
            let historyOptions = 'è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„å†å²å‘¨æœŸ | Please select a history period to view:\n\n';
            purchaseHistory.forEach((record, index) => {
                const startDate = record.periodStart.toLocaleDateString();
                const endDate = record.periodEnd.toLocaleDateString();
                const totalValue = record.totalValue.toFixed(2);
                historyOptions += `${index + 1}. ${startDate} - ${endDate} (${record.totalItems}ä¸ªå•†å“ | items, æ€»ä»·å€¼ | total value: ${totalValue}å…ƒ)\n`;
            });
            
            const choice = prompt(historyOptions + '\nè¯·è¾“å…¥åºå· | Enter number (1-' + purchaseHistory.length + '):');
            const selectedIndex = parseInt(choice) - 1;
            
            if (selectedIndex >= 0 && selectedIndex < purchaseHistory.length) {
                displayHistoryPeriod(selectedIndex);
            }
        }

        // æ˜¾ç¤ºæŒ‡å®šå†å²å‘¨æœŸ
        function displayHistoryPeriod(index) {
            const record = purchaseHistory[index];
            const startDate = record.periodStart.toLocaleDateString();
            const endDate = record.periodEnd.toLocaleDateString();
            
            // æ›´æ–°å†å²ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('historyPeriodInfo').textContent = 
                `å‘¨æœŸ | Period: ${startDate} - ${endDate} | å•†å“æ•°é‡ | Items: ${record.totalItems} | æ€»ä»·å€¼ | Total Value: ${record.totalValue.toFixed(2)}å…ƒ`;
            
            // æ¸²æŸ“å†å²è¡¨æ ¼
            const tbody = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            record.items.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = item.price.toFixed(2);
                row.insertCell().textContent = item.supplier;
                row.insertCell().textContent = item.priority;
                row.insertCell().textContent = item.notes;
                row.insertCell().textContent = item.addedBy;
                row.insertCell().textContent = item.addedAt;
                row.insertCell().textContent = (item.quantity * item.price).toFixed(2);
            });
            
            // æ˜¾ç¤ºå†å²åŒºåŸŸï¼Œéšè—å…¶ä»–åŒºåŸŸ
            document.getElementById('historyArea').style.display = 'block';
            document.getElementById('purchaseForm').parentElement.style.display = 'none';
            document.getElementById('currentItemsTable').parentElement.style.display = 'none';
            document.getElementById('approvalArea').parentElement.style.display = 'none';
        }

        // å…³é—­å†å²è§†å›¾
        function closeHistoryView() {
            document.getElementById('historyArea').style.display = 'none';
            document.getElementById('purchaseForm').parentElement.style.display = 'block';
            document.getElementById('currentItemsTable').parentElement.style.display = 'block';
            if (document.getElementById('approvalArea').style.display !== 'none') {
                document.getElementById('approvalArea').parentElement.style.display = 'block';
            }
        }

        // æ›´æ–°å‘¨æœŸçŠ¶æ€æ˜¾ç¤º
        function updatePeriodStatus() {
            const currentPeriodStartElement = document.getElementById('currentPeriodStart');
            const nextUpdateDateElement = document.getElementById('nextUpdateDate');
            const editingStatusElement = document.getElementById('editingStatus');
            const historyCountElement = document.getElementById('historyCount');
            
            if (currentPeriodStartElement && currentPeriodStart) {
                currentPeriodStartElement.textContent = currentPeriodStart.toLocaleDateString();
            }
            
            if (nextUpdateDateElement && nextUpdateDate) {
                nextUpdateDateElement.textContent = nextUpdateDate.toLocaleDateString();
            }
            
            if (editingStatusElement) {
                if (isEditingEnabled) {
                    editingStatusElement.innerHTML = 'ğŸŸ¢ å…è®¸ç¼–è¾‘';
                    editingStatusElement.style.color = '#28a745';
                } else {
                    editingStatusElement.innerHTML = 'ğŸ”´ ç¦æ­¢ç¼–è¾‘';
                    editingStatusElement.style.color = '#dc3545';
                }
            }
            
            if (historyCountElement) {
                historyCountElement.textContent = purchaseHistory.length;
            }
        }

        // ä¿å­˜å…±äº«æ•°æ®åˆ°localStorage
        function saveSharedData() {
            const sharedData = {
                purchaseItems: sharedPurchaseItems,
                approvalItems: sharedApprovalItems,
                approvalFileName: sharedApprovalFileName,
                lastUpdate: Date.now(),
                updateUser: currentUser?.name || 'Unknown'
            };
            
            try {
                localStorage.setItem('sharedPurchaseData', JSON.stringify(sharedData));
                localStorage.setItem('lastDataUpdate', sharedData.lastUpdate.toString());
                
                // è§¦å‘storageäº‹ä»¶ä»¥é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µ
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'sharedPurchaseData',
                    newValue: JSON.stringify(sharedData),
                    oldValue: localStorage.getItem('sharedPurchaseData'),
                    storageArea: localStorage
                }));
                
                console.log('å…±äº«æ•°æ®å·²ä¿å­˜å¹¶å¹¿æ’­:', sharedData);
            } catch (error) {
                console.error('ä¿å­˜å…±äº«æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä»localStorageåŠ è½½å…±äº«æ•°æ®
        function loadSharedData() {
            try {
                const sharedDataStr = localStorage.getItem('sharedPurchaseData');
                if (sharedDataStr) {
                    const sharedData = JSON.parse(sharedDataStr);
                    sharedPurchaseItems = sharedData.purchaseItems || [];
                    sharedApprovalItems = sharedData.approvalItems || [];
                    sharedApprovalFileName = sharedData.approvalFileName || '';
                    console.log('å·²åŠ è½½å…±äº«æ•°æ®:', sharedData);
                }
            } catch (error) {
                console.error('åŠ è½½å…±äº«æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥æ•°æ®æ›´æ–°
        function checkForDataUpdates() {
            if (!isCollaborationEnabled || !currentUser) return;
            
            const savedData = localStorage.getItem('sharedPurchaseData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    const lastUpdate = data.lastUpdate || 0;
                    const currentLastUpdate = localStorage.getItem('lastDataUpdate') || '0';
                    
                    // å¦‚æœå‘ç°æ–°çš„æ›´æ–°
                    if (lastUpdate > parseInt(currentLastUpdate)) {
                        console.log('æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼ŒåŒæ­¥ä¸­...');
                        
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        sharedPurchaseItems = data.purchaseItems || [];
                        sharedApprovalItems = data.approvalItems || [];
                        sharedApprovalFileName = data.approvalFileName || '';
                        
                        // åŒæ­¥åˆ°å½“å‰ç”¨æˆ·ç•Œé¢
                        purchaseItems = [...sharedPurchaseItems];
                        itemsForApproval = [...sharedApprovalItems];
                        
                        // æ›´æ–°æ˜¾ç¤º
                        renderCurrentItemsTable();
                        if (itemsForApproval.length > 0) {
                            document.getElementById('approvalFileName').textContent = `(æ–‡ä»¶: ${sharedApprovalFileName})`;
                            document.getElementById('approvalArea').style.display = 'block';
                            renderApprovalTable();
                        }
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateSharedItemsStatus();
                        
                        // è®°å½•æœ€åæ›´æ–°æ—¶é—´
                        localStorage.setItem('lastDataUpdate', lastUpdate.toString());
                        
                        // æ·»åŠ åŒæ­¥è®°å½•
                        if (data.updateUser && data.updateUser !== currentUser.name) {
                            addEditHistory('æ•°æ®åŒæ­¥', `åŒæ­¥äº† ${data.updateUser} çš„æ›´æ–°`);
                        }
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æ•°æ®æ›´æ–°å¤±è´¥:', error);
                }
            }
        }

        // å®¡æ ¸å•†å“
        function approveItem(index) {
            const item = itemsForApproval[index];
            item.status = 'approved';
            item.approvedBy = currentUser?.name || 'Unknown';
            item.approvedAt = new Date().toLocaleString('zh-CN');
            
            // å®æ—¶åŒæ­¥å®¡æ ¸æ•°æ®
            if (isCollaborationEnabled) {
                sharedApprovalItems = [...itemsForApproval];
                saveSharedData();
                addEditHistory('å®¡æ ¸é€šè¿‡ | Approve Item', `${currentUser?.name || 'Unknown'} å®¡æ ¸é€šè¿‡äº† | approved ${item.name}`);
            }
            
            renderApprovalTable();
        }

        // æ‹’ç»å•†å“
        function rejectItem(index) {
            const item = itemsForApproval[index];
            item.status = 'rejected';
            item.rejectedBy = currentUser?.name || 'Unknown';
            item.rejectedAt = new Date().toLocaleString('zh-CN');
            
            // å®æ—¶åŒæ­¥å®¡æ ¸æ•°æ®
            if (isCollaborationEnabled) {
                sharedApprovalItems = [...itemsForApproval];
                saveSharedData();
                addEditHistory('å®¡æ ¸æ‹’ç» | Reject Item', `${currentUser?.name || 'Unknown'} æ‹’ç»äº† | rejected ${item.name}`);
            }
            
            renderApprovalTable();
        }

        // æ¸…ç©ºå®¡æ ¸åˆ—è¡¨
        function clearApprovalList() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå®¡æ ¸åˆ—è¡¨å—ï¼Ÿ | Are you sure you want to clear the approval list?')) {
                itemsForApproval = [];
                sharedApprovalFileName = '';
                
                // å®æ—¶åŒæ­¥å®¡æ ¸æ•°æ®
                if (isCollaborationEnabled) {
                    sharedApprovalItems = [];
                    saveSharedData();
                    addEditHistory('æ¸…ç©ºå®¡æ ¸åˆ—è¡¨ | Clear Approval List', `${currentUser?.name || 'Unknown'} æ¸…ç©ºäº†å®¡æ ¸åˆ—è¡¨ | cleared approval list`);
                }
                
                document.getElementById('approvalArea').style.display = 'none';
            }
        }

        // æ¸…é™¤è¡¨å•
        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemSupplier').value = '';
            document.getElementById('itemPriority').value = 'medium';
            document.getElementById('itemNotes').value = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åŠ è½½å†å²æ•°æ®
            loadPurchaseHistory();
            
            // åˆå§‹åŒ–é‡‡è´­å‘¨æœŸ
            initializePurchasePeriod();
            
            // æ¸²æŸ“å½“å‰å•†å“åˆ—è¡¨
            renderCurrentItemsTable();
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateSharedItemsStatus();
            
            // åˆå§‹åŒ–åä½œåŠŸèƒ½
            initializeCollaboration();
            
            // åŠ è½½åœ¨çº¿ç”¨æˆ·
            const savedUsers = localStorage.getItem('onlineUsers');
            if (savedUsers) {
                try {
                    onlineUsers = JSON.parse(savedUsers);
                } catch (error) {
                    console.error('åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
                }
            }
            
            // åŠ è½½ç¼–è¾‘å†å²
            const savedHistory = localStorage.getItem('editHistory');
            if (savedHistory) {
                try {
                    editHistory = JSON.parse(savedHistory);
                    renderEditHistory();
                } catch (error) {
                    console.error('åŠ è½½ç¼–è¾‘å†å²å¤±è´¥:', error);
                }
            }
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
